<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>صانع تقارير الجولات</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ===== أساسيات (Mobile‑first) ===== */
    :root{
      --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --bg:#f8fafc; --card:#ffffff;
      --brand:#3b82f6; --ok:#10b981; --danger:#ef4444; --chip:#eef2ff; --chipText:#1e3a8a;
      --shadow:0 10px 24px rgba(0,0,0,.06);
      --radius:14px;
    }
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Cairo',system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--ink);}

    /* خلفية صباح/مساء هادئة */
    body[data-theme="morning"]{background:linear-gradient(180deg,#e0f2ff,#f8fbff)}
    body[data-theme="evening"]{background:linear-gradient(180deg,#0b1020,#1c1530);color:#eef2ff}
    body[data-theme="evening"] .card{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12)}
    body[data-theme="evening"] .muted{color:#c7d2fe}

    .page{max-width:680px; margin-inline:auto; padding:16px 14px 24px}
    h1{margin:10px 0 4px; font-size:clamp(22px, 4vw, 28px)}
    .muted{color:var(--muted)}

    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow)}

    /* صف الإدخال (Mobile‑first: عمود واحد) */
    .row{display:grid; grid-template-columns:1fr; gap:10px}
    @media (min-width:560px){ .row{grid-template-columns:1fr 1fr auto} }

    label{font-size:14px; color:var(--muted); margin-bottom:6px; display:block}
    input[type="text"]{width:100%; padding:14px; border:1px solid var(--line); border-radius:12px; font:inherit}

    /* أزرار: توحيد الخط = نفس خط الصفحة */
    .btn{appearance:none; border:0; border-radius:12px; padding:14px 16px; cursor:pointer; font-family:inherit; font-weight:700; line-height:1; 
         transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease; min-height:48px;}
    .btn:active{transform:translateY(1px)}
    .btn-ghost{background:#fff; border:1px solid var(--line)}
    .btn-primary{background:var(--brand); color:#fff; box-shadow:0 8px 18px rgba(59,130,246,.22)}
    /* زر التصدير المطلوب: أخضر */
    .btn-success{background:var(--ok); color:#fff; box-shadow:0 8px 18px rgba(16,185,129,.22)}
    .btn-danger{background:var(--danger); color:#fff}
    body[data-theme="evening"] .btn-ghost{background:transparent; color:#eef2ff; border-color:rgba(255,255,255,.12)}

    .list{margin-top:12px; display:grid; gap:8px}
    .item{display:flex; gap:10px; align-items:center; justify-content:space-between; border:1px dashed var(--line); border-radius:12px; padding:12px; background:#fff}
    body[data-theme="evening"] .item{background:rgba(255,255,255,.04)}
    .item b{font-weight:700}
    .item small{color:var(--muted)}

    .footer-actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:space-between; align-items:center; margin-top:14px}
    .hint{font-size:13px}

    .chip{display:inline-flex; align-items:center; gap:8px; background:var(--chip); color:var(--chipText); padding:8px 12px; border-radius:999px; font-size:13px}
    body[data-theme="evening"] .chip{background:#312e81; color:#c7d2fe}

    .hero{margin:8px 0 14px}
  </style>
</head>
<body>
  <div class="page">
    <h1>صانع تقارير الجولات</h1>
    <div class="hero muted" id="greet"></div>

    <div class="card">
      <div class="row">
        <div>
          <label>اسم المعلمة</label>
          <input id="tName" type="text" placeholder="مثال: أمل الشريف" />
        </div>
        <div>
          <label>سبب عدم الحضور</label>
          <input id="tReason" type="text" placeholder="مثال: انقطاع الإنترنت" />
        </div>
        <div style="display:flex;gap:8px;align-items:flex-end;justify-content:flex-end">
          <button class="btn btn-primary" id="addRow">+ إضافة</button>
        </div>
      </div>

      <div class="list" id="list"></div>

      <div class="footer-actions">
        <span class="chip" id="count">لا توجد متغيبات</span>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-ghost" id="clear">مسح الكل</button>
          <button class="btn btn-success" id="export">تصدير التقرير الآن</button>
        </div>
      </div>
      <div class="hint muted" style="margin-top:6px">اليوم والتاريخ تُملأ تلقائيًا داخل الـ PDF. يمكنك التصدير بدون إضافة أسماء.</div>
    </div>
  </div>

  <script>
    // تحية تلقائية + سمة صباح/مساء
    (function(){
      const h = new Date().getHours();
      const morning = h >= 5 && h < 17;
      document.body.setAttribute('data-theme', morning ? 'morning' : 'evening');
      document.getElementById('greet').textContent = morning ? 'صباح الخير ابتسام ☀️' : 'مساء الخير ابتسام 🌙';
    })();

    const $ = (s)=>document.querySelector(s);
    const list = $('#list');
    const tName = $('#tName');
    const tReason = $('#tReason');
    const countChip = $('#count');

    function renderCount(){
      const n = list.children.length;
      countChip.textContent = n ? `عدد المتغيبات: ${n}` : 'لا توجد متغيبات';
    }

    function addRow(name, reason){
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `
        <div style="flex:1;min-width:0">
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <b class="name"></b>
            <small class="reason muted"></small>
          </div>
        </div>
        <button class="btn btn-danger btn-sm">حذف</button>`;
      el.querySelector('.name').textContent = name;
      el.querySelector('.reason').textContent = `— ${reason}`;
      el.querySelector('button').onclick = ()=>{ el.remove(); renderCount(); };
      list.appendChild(el);
      renderCount();
    }

    function tryAdd(){
      const name = tName.value.trim();
      const reason = tReason.value.trim();
      if(!name || !reason){
        // تبسيط: من دون تنبيه مزعج — نوجه التركيز
        if(!name) tName.focus(); else tReason.focus();
        return;
      }
      addRow(name, reason);
      tName.value = '';
      tReason.value = '';
      tName.focus();
    }

    $('#addRow').onclick = tryAdd;
    tReason.addEventListener('keydown', (e)=>{ if(e.key==='Enter') tryAdd(); });
    tName.addEventListener('keydown', (e)=>{ if(e.key==='Enter') tReason.focus(); });

    $('#clear').onclick = ()=>{
      if(!list.children.length) return;
      if(confirm('مسح جميع المتغيبات؟')){ list.innerHTML=''; renderCount(); }
    };

    $('#export').onclick = async ()=>{
      const rows = Array.from(list.children).map((el)=>({
        name: el.querySelector('.name').textContent.trim(),
        reason: el.querySelector('.reason').textContent.replace(/^—\s*/, '').trim(),
      }));

      const fd = new FormData();
      fd.append('rows_json', JSON.stringify(rows));

      const btn = $('#export');
      const label = btn.textContent;
      btn.disabled = true; btn.textContent = 'جارٍ إنشاء التقرير…';

      // دعم التشغيل من :3000 أو :8000
      const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') && (location.port === '3000')
        ? 'http://127.0.0.1:8000' : '';

      try{
        const res = await fetch(`${API_BASE}/api/pdf`, { method:'POST', body: fd });
        if(!res.ok){ throw new Error(await res.text()); }
        const blob = await res.blob();
        const a = document.createElement('a');
        const url = URL.createObjectURL(blob);
        a.href = url; a.download = `تقرير_الجولات_${Date.now()}.pdf`;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }catch(e){
        alert('تعذر إنشاء PDF');
      }finally{
        btn.disabled = false; btn.textContent = label;
      }
    };
  </script>
</body>
</html>
